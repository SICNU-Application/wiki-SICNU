<!DOCTYPE html>
<html lang="en">
<head>
 
  <!-- 白天、夜间模式切换 -->
  <!-- stylesheets -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/dark.css" disabled>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css" >
  
  <meta charset="UTF-8">
  <meta name="baidu-site-verification" content="codeva-OmVvLISv9o" />
  <title>四川师范大学飞跃手册</title>
  <!-- 如果要走301重定向的跳转方式 -->
  <!-- <meta http-equiv="refresh" content="0; url=https://www.sicnuwiki.com"> -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Description">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  
  <!-- 默认样式 -->
  <!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css"> -->
  <link rel="shortcut icon" href="src/sicnu校徽.png"  />
  <!-- 设置上下页跳转字体大小 -->
  <style>
    .pagination-item-title {
      font-size: 1em !important;
    }
    body {
      font-size: 17px;
      line-height: 1.2; /* 可根据需要调整行间距的大小 */
    }
  </style>

  <style>
   /* 使菜单按钮更加醒目 */
   .sidebar-toggle {
    background-color: #42B983 !important;
    width: 40px !important;
    height: 40px !important;
    border-radius: 50% !important;
    padding: 10px !important;
    opacity: 0.8 !important;
    transition: all 0.3s ease !important;
  }

  .sidebar-toggle:hover {
    opacity: 1 !important;
    transform: scale(1.1) !important;
  }

  .sidebar-toggle span {
    background-color: white !important;
    height: 2px !important;
    width: 16px !important;
    margin: 4px auto !important;
  }
  
  /* 可选：使侧边栏本身更醒目 */
  .sidebar {
    border-right: 2px solid #42B983 !important;
  }
  
  /* 针对移动设备的响应式调整 */
  @media screen and (max-width: 768px) {
    .sidebar-toggle {
      width: 32px !important;
      height: 32px !important;
      padding: 8px !important;
    }
    
    .sidebar-toggle span {
      width: 14px !important;
      margin: 3px auto !important;
    }
  }

  /* Twikoo 评论框布局修复 */
  #tcomment {
    max-width: 100% !important;
    width: 100% !important;
    margin: 30px 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    overflow: hidden !important;
  }

  /* 确保 Twikoo 容器不超出内容区域 */
  .content #tcomment {
    clear: both !important;
  }

  /* Twikoo 内部元素宽度限制 */
  #tcomment * {
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  /* Twikoo 输入框和按钮布局 */
  #tcomment .tk-submit {
    margin-right: 0 !important;
  }

  /* 评论列表样式优化 */
  #tcomment .tk-comments {
    max-width: 100% !important;
    overflow-x: hidden !important;
  }

  /* Docsify 内容区域宽度控制 */
  .markdown-section {
    max-width: 100% !important;
    padding: 30px 15px 40px !important;
  }

  /* 确保内容容器宽度正常 */
  .content {
    overflow-x: hidden !important;
  }

  /* Twikoo 表单行布局 */
  #tcomment .tk-row {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 10px !important;
  }

  #tcomment .tk-col {
    flex: 1 1 auto !important;
    min-width: 0 !important;
  }

  /* Twikoo 输入框 */
  #tcomment input,
  #tcomment textarea {
    width: 100% !important;
    max-width: 100% !important;
  }

  /* 移动端评论框适配 */
  @media screen and (max-width: 768px) {
    #tcomment {
      padding: 0 10px !important;
    }
    
    #tcomment .tk-row {
      flex-direction: column !important;
    }

    #tcomment .tk-col {
      width: 100% !important;
    }
  }
  </style>
  
</head>
<body>
  <div id="app"></div>
  <script>
    window.$docsify = {
    // 上下页跳转
    pagination: { 
      previousText: '上一章节',
      nextText: {
       '/en/': 'NEXT',
       '/': '下一章节'
      },
    crossChapter: true,
    crossChapterText: true,
    },
    // 字数统计设置
      count:{
        countable: true,
        position: 'top',
        fontsize:'1em',
      },
    //颜色管理插件
      switchLightDarkMode: {
        useSwitchMode: true,
        top: 130,
        right: 26,
        svgColor: '#7d7b75',
      },
      name: ''
      ,repo: ''
      // ,repo: 'https://github.com/SICNU-Application/wiki-SICNU'
      // load DIY SideBar
      ,loadSidebar: true
      // 统一使用根目录侧边栏，避免子目录 404
      ,alias: {
        '/.*/_sidebar.md': '/_sidebar.md'
      }
      //设置侧边栏的目录名作为正文的标题
      ,autoHeader: true
      //侧边栏顶部标题
      ,name: '飞跃手册-川师大'
      // load DIY Cover
      ,coverpage: true
      //仅加载一次封面
      ,onlyCover:true
      //切换页面后是否自动跳转到页面顶部
      ,auto2top: true
      , //全文搜索
      search: {
        maxAge: 86400000, // 过期时间，单位毫秒，默认一天
        paths: 'auto',
        placeholder: '搜索你想要的...',
        noData: '找不到结果',
        // 搜索标题的最大程级, 1 - 6
        depth: 3,
      }
      // 添加最后更新日期功能。https://github.com/rxmapple/docsify-last-modified
      ,lastModified:{
        // 默认：优先同源 HEAD(腾讯 COS/OSS)，GitHub 作为备用
        // 想“优先 GitHub API”就设为 false
        preferHead: true
        ,repo:'SICNU-Application/wiki-SICNU'
        ,basePath: 'docs/'
        ,preString: "最后更新: "
        ,dateFormat: "{YYYY} 年 {MM} 月 {DD} 日"
        ,align:'right'
      },
      // 添加Twikoo评论系统插件
      plugins: [
        function(hook, vm) {
          // 绑定灯箱效果
          hook.afterEach(function(html) {
            window.ViewImage && ViewImage.init('.ebook img,a.zoom');
          });
          function ensureTcomment() {
            // 先确保只有一个 tcomment 容器
            removeAllTcomment();
            var a = Docsify.dom;
            var n = a.create("div");
            n.id = "tcomment";
            var content = a.find(".content");
            if (content) {
              a.appendTo(content, n);
            }
            return n;
          }

          function removeAllTcomment() {
            // 移除所有 #tcomment 容器
            var nodes = document.querySelectorAll('#tcomment');
            for (var i = 0; i < nodes.length; i++) {
              if (nodes[i] && nodes[i].parentNode) {
                nodes[i].parentNode.removeChild(nodes[i]);
              }
            }
            // 同时移除 Twikoo 可能创建的弹窗/遮罩等全局元素
            var tkModals = document.querySelectorAll('.tk-lightbox, .tk-action-icon__dialog, .tk-image-viewer');
            for (var j = 0; j < tkModals.length; j++) {
              if (tkModals[j] && tkModals[j].parentNode) {
                tkModals[j].parentNode.removeChild(tkModals[j]);
              }
            }
          }
          
          // 全局销毁函数，用于页面切换前彻底清理
          function destroyTwikoo() {
            // 停止所有定时器和观察者
            if (twikooTimer) {
              clearTimeout(twikooTimer);
              twikooTimer = null;
            }
            if (twikooObserver) {
              twikooObserver.disconnect();
              twikooObserver = null;
            }
            twikooLoading = false;
            // 彻底移除评论容器
            removeAllTcomment();
          }

          function normalizeCommentPath(path) {
            var p = decodeURIComponent(path || '/').trim();
            if (!p || p === '#') return '/';
            if (p.charAt(0) !== '/') p = '/' + p;
            p = p.replace(/\/\.\//g, '/');
            p = p.replace(/\/{2,}/g, '/');
            // 统一 README 首页写法
            if (p === '/README' || p === '/README.md' || p === '/./README') return '/README';
            return p;
          }

          // 动态插入 div#tcomment 的 dom 
          hook.mounted(function () {
            // 初始化时不创建，等 doneEach 再创建
          })
          
          // 页面开始切换时（路由变化前）清理
          hook.beforeEach(function(content) {
            destroyTwikoo();
            return content;
          })
          
          // twikoo 初始化控制变量
          var twikooTimer = null;
          var twikooObserver = null;
          var twikooLoading = false;
          var lastPath = null;
          var twikooToken = 0;

          function loadTwikoo(path, token) {
            if (token !== twikooToken) return;
            if (twikooLoading) return;
            
            // 检查是否已有评论容器
            var tcomment = document.getElementById('tcomment');
            if (!tcomment) return;
            
            twikooLoading = true;
            tcomment.innerHTML = '';
            
            twikoo.init({
                envId: 'https://twikooeo.sicnuwiki.com',
                el: '#tcomment',
                lang: 'zh-CN',
                path: path,
                onCommentLoaded: function () {
                  window.ViewImage && ViewImage.init('.tk-content img:not(.avatar,.tk-avatar-img,.tk-owo-emotion),.ebook img,a.zoom');
                }
            }).then(function () {
              if (token !== twikooToken) return;
              twikooLoading = false;
            }).catch(function () {
              twikooLoading = false;
            });
          }

          function observeAndLoad(path, token) {
            if (twikooObserver) {
              twikooObserver.disconnect();
              twikooObserver = null;
            }
            if (twikooTimer) {
              clearTimeout(twikooTimer);
              twikooTimer = null;
            }

            var tcomment = document.getElementById('tcomment');
            if (!tcomment) return;

            if (!('IntersectionObserver' in window)) {
              twikooTimer = setTimeout(function () {
                loadTwikoo(path, token);
              }, 0);
              return;
            }

            twikooObserver = new IntersectionObserver(function (entries) {
              if (!entries || !entries.length) return;
              if (entries[0].isIntersecting) {
                if (twikooObserver) {
                  twikooObserver.disconnect();
                  twikooObserver = null;
                }
                twikooTimer = setTimeout(function () {
                  loadTwikoo(path, token);
                }, 0);
              }
            }, { rootMargin: '200px 0px' });

            twikooObserver.observe(tcomment);
          }
          
          // 调用 twikoo 评论，正则 path，刷新当前评论
          hook.doneEach(function () {
            // ★★★ 第一步：立即彻底销毁旧的 Twikoo 实例和容器 ★★★
            destroyTwikoo();
            
            // 获取当前 docsify 页面路径作为评论区分标识
            var currentPath = normalizeCommentPath(vm.route.path || location.hash.replace(/^#/, '').replace(/\?.*$/, '') || '/');
            
            // 更新路径记录
            lastPath = currentPath;

            // 切换页面时更新 token，避免旧请求回流渲染
            twikooToken += 1;
            var currentToken = twikooToken;
            twikooLoading = false;
            
            // ★★★ 第二步：延迟创建新的评论容器，确保 DOM 已更新 ★★★
            setTimeout(function() {
              // 检查 token 是否仍然有效（防止快速切换页面时的竞态条件）
              if (currentToken !== twikooToken) return;
              
              // 再次清理，确保没有残留
              removeAllTcomment();
              
              // 创建新的评论容器
              var tcomment = ensureTcomment();
              if (tcomment) {
                observeAndLoad(currentPath, currentToken);
              }
            }, 50);
          })
        }
      ]
    }
  </script>

<!-- 不蒜子-访问量统计 -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- 不蒜子初始化 -->

  <!-- Docsify v4 -->
  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
    <!--全文搜索,直接用官方提供的无法生效-->
  <script src="https://cdn.bootcss.com/docsify/4.5.9/plugins/search.min.js"></script>
  <!-- 图片缩放 -->
  <script src="//unpkg.com/docsify/lib/plugins/zoom-image.js"></script>
  <!-- 字数统计 -->
  <script src="//unpkg.com/docsify-count/dist/countable.js"></script>
  <!-- 表情插件 -->
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/emoji.min.js"></script>
  <!-- docsify-updated -->
  <script src="//cdn.jsdelivr.net/npm/tinydate@1.3.0/dist/tinydate.min.js"></script>
  <script src="./src/_assert/docsify-last-modified.js"></script> 
  <!-- docsify-simple-dark-mode plugin -->
  <script src="https://cdn.jsdelivr.net/gh/pikapikapikaori/docsify-simple-dark-mode@latest/src/switchLightDarkMode.js"></script>
  <!-- 上下章节跳转 -->
  <script src="//unpkg.com/docsify-pagination/dist/docsify-pagination.min.js"></script>
  <!-- 返回顶部 -->
  <script src="https://cdn.jsdelivr.net/gh/Sumsung524/docsify-backTop/dist/docsify-backTop.min.js"></script>
  <!-- Twikoo评论系统 -->
  <script src="https://cdn.staticfile.org/twikoo/1.6.44/twikoo.all.min.js"></script>
</body>
</html>
